# Welcome to pgcrud

pgcrud is a Python package that makes **C**reate, **R**ead, **U**pdate, and **D**elete (**CRUD**) operations for PostgreSQL simple and fast. 

- **Pydantic**: Native Pydantic integration.
- **PostgreSQL**: Tailored to PostgreSQL with wide extensions support.
- **Flexible**: Handle complex parent-child relationships.
- **Safe**: Protection against SQL-Injection.
- **Asynchronous**: Perform operations asynchronously (or synchronously).
- **Lightweight**: Easy to integrate into existing projects.
- **Type Hints**: Full type hint support.

## Dependencies

pgcrud is build on top of

- [psycopg](https://www.psycopg.org): the popular PostgreSQL adapter
- [pydantic](https://docs.pydantic.dev/latest/): the #1 library for data serialization and validation.

## Installation

pgcrud is not yet available on PyPI. However, you can install it using pip with the following command:

```
pip install git+https://github.com/dakivara/pgcrud.git
```

Do not download the pgcrud package from PyPi. This is an abandoned package and is not affiliated with us.


## Examples

This is a glimpse into pgcrud's core functionality. For more detailed instructions and advanced examples, be sure to 
explore the rest of the documentation. There is much more to discover!

To demonstrate pgcrud's core functionality, we use a simple Author model based on an *author* table with 
the columns *id*, *name*, and *date_of_birth*.

### Create

The `insert_one` / `insert_many` methods are used to insert one / many records into a table. You must specify into which table 
you want to insert and which columns you want to populate. You can simply insert new records from Pydantic objects. Typically, the id
column is autogenerated and you can retrieve it after insertion.

```python
from datetime import date

from psycopg import Cursor
from pydantic import BaseModel

import pgcrud as pg
from pgcrud import e


class AuthorInput(BaseModel):
    name: str
    date_of_birth: date

    
def insert_author(cursor: Cursor[int], input: AuthorInput) -> int | None:
    return pg.insert_one(
        cursor=cursor,
        insert_into=e.author[e.name, e.date_of_birth],
        values=input,
        returning=e.id,
    )
```

### Read

The `get_one` / `get_many` methods are used to retrieve one / many records from a table. You must specify from with table you want to select
the records. You can directly load the fetched records into a Pydantic model. The `where` condition specifies which records should be retrieved. 
If the where condition matches multiple records, the `get_one` method will return the first record that meets the filter criteria.

```python
from datetime import date

from psycopg import Cursor
from pydantic import BaseModel

import pgcrud as pg
from pgcrud import e


class Author(BaseModel):
    id: int
    name: str
    date_of_birth: date

    
def get_author(cursor: Cursor[Author], id: int) -> Author | None:
    return pg.get_one(
        cursor=cursor,
        select=Author,
        from_=e.author,
        where=e.id == id,
    )
```

### Update

The `update_many` method is used to update records in a table.[^1] You need to specify which table and which columns you want to update. 
The `where` condition specifies which records should be updated. To update a single record, you must ensure that the `where` condition 
targets a single record. 

[^1]: An `update_one` method does not exist because PostgreSQL's UPDATE command does not inherently target a single record.

```python
from datetime import date

from psycopg import Cursor
from pydantic import BaseModel

import pgcrud as pg
from pgcrud import e


class AuthorUpdate(BaseModel):
    name: str
    date_of_birth: date

    
def update_author(cursor: Cursor, update: AuthorUpdate, id: int) -> None:
    pg.update_many(
        cursor=cursor,
        update=e.author,
        set_=((e.name, e.date_of_birth), update),
        where=e.id == id,
    )
```

### Delete

The `delete_many` method is used to delete records from a table.[^2] You need to specify from which table you want to delete the records. 
The `where` condition specifies which records should be deleted. To delete a single record, you must ensure that the `where` condition 
targets a single record. 

[^2]: A `delete_one` method does not exist because PostgreSQL's DELETE command does not inherently target a single record.

```python
from psycopg import Cursor

import pgcrud as pg
from pgcrud import e

    
def delete_author(cursor: Cursor, id: int) -> None:
    pg.delete_many(
        cursor=cursor,
        delete_from=e.author,
        where=e.id == id,
    )
```

## License

pgcrud is released under the MIT License.
